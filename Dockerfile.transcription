# ==============================================================================
# Angel Intelligence - Transcription Pod Dockerfile
# ==============================================================================
# Shared WhisperX transcription service with speaker diarization
# Image size: ~4GB (torch + WhisperX + pyannote)
#
# Build: docker build -f Dockerfile.transcription -t angel-intelligence:transcription .
# Run:   docker run --gpus all -p 8001:8001 angel-intelligence:transcription
#
# Requires:
#   - NVIDIA GPU with ~10GB VRAM
#   - HUGGINGFACE_TOKEN with pyannote access

FROM nvidia/cuda:12.1-runtime-ubuntu22.04

LABEL org.opencontainers.image.title="Angel Intelligence Transcription"
LABEL org.opencontainers.image.description="Shared WhisperX transcription service"

ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV ANGEL_ENV=production
ENV DEBIAN_FRONTEND=noninteractive

# Install Python and system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 \
    python3.10-dev \
    python3-pip \
    ffmpeg \
    sox \
    libsox-fmt-all \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3.10 /usr/bin/python

WORKDIR /app

# Upgrade pip
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# Install PyTorch with CUDA
RUN pip install --no-cache-dir torch==2.5.1 torchaudio==2.5.1 \
    --index-url https://download.pytorch.org/whl/cu121

# Copy requirements
COPY requirements/base.txt requirements/
COPY requirements/transcription.txt requirements/

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements/transcription.txt

# Install WhisperX from git
RUN pip install --no-cache-dir git+https://github.com/m-bain/whisperx.git

# Copy only necessary code for transcription service
COPY src/api/app.py src/api/
COPY src/api/routes.py src/api/
COPY src/api/__init__.py src/api/
COPY src/config/ src/config/
COPY src/database/ src/database/
COPY src/services/transcriber.py src/services/
COPY src/services/__init__.py src/services/
COPY src/__init__.py src/

# Create non-root user
RUN useradd -m -u 1000 angel && chown -R angel:angel /app
USER angel

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8001/internal/health || exit 1

EXPOSE 8001

# Run transcription API (serves /internal/transcribe endpoint)
CMD ["uvicorn", "src.api:app", "--host", "0.0.0.0", "--port", "8001"]
