# ==============================================================================
# Angel Intelligence - Transcription Pod Dockerfile (Jetson ARM64)
# ==============================================================================
# Uses dustynv/wyoming-whisper which has faster-whisper + ctranslate2 CUDA pre-built!
# No compilation required - instant build.
#
# Build: docker build -f Dockerfile.transcription-jetson -t angel-intelligence:transcription-arm64 .
# Run:   docker run --runtime nvidia -p 8001:8001 angel-intelligence:transcription-arm64

# Use L4T PyTorch image with torchaudio 2.1+ for pyannote-audio 3.3.x compatibility
# r36.2.0 includes PyTorch 2.1+ with compatible torchaudio
FROM dustynv/l4t-pytorch:r36.2.0

LABEL org.opencontainers.image.title="Angel Intelligence Transcription (Jetson)"
LABEL org.opencontainers.image.description="Shared WhisperX transcription service for ARM64"

# Fix ARM64 OpenMP TLS issue
ENV LD_PRELOAD=/usr/lib/aarch64-linux-gnu/libgomp.so.1
ENV PYTHONUNBUFFERED=1
ENV ANGEL_ENV=production

WORKDIR /workspace

# Install additional system dependencies
RUN rm -rf /var/lib/apt/lists/* && \
    apt-get clean && \
    apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends \
        sox libsox-fmt-all \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements/base.txt requirements/
COPY requirements/transcription.txt requirements/

# Reset pip index to use PyPI as primary, Jetson as extra
# This fixes setuptools not found during build
ENV PIP_INDEX_URL=https://pypi.org/simple
ENV PIP_EXTRA_INDEX_URL=http://jetson.webredirect.org/jp6/cu122

# faster-whisper and ctranslate2 already in base image!
# Just install WhisperX and pyannote for alignment + diarization
RUN pip install --no-cache-dir git+https://github.com/m-bain/whisperx.git --no-deps

# Install pyannote for speaker diarization
RUN pip install --no-cache-dir pyannote.audio

# Install minimal WhisperX deps
RUN pip install --no-cache-dir pandas nltk more-itertools

# Install remaining transcription dependencies
RUN pip install --no-cache-dir -r requirements/transcription.txt 2>/dev/null || true

# Fix all bundled libgomp conflicts - find and replace ALL of them with system libgomp
RUN find /usr/local/lib -name "libgomp*.so*" -type f 2>/dev/null | while read f; do \
        rm -f "$f" && ln -sf /usr/lib/aarch64-linux-gnu/libgomp.so.1 "$f"; \
    done || true

# Copy only necessary code
COPY src/api/app.py src/api/
COPY src/api/auth.py src/api/
COPY src/api/routes.py src/api/
COPY src/api/routes_live.py src/api/
COPY src/api/__init__.py src/api/
COPY src/config/ src/config/
COPY src/database/ src/database/
COPY src/services/ src/services/
COPY src/__init__.py src/

EXPOSE 8001

CMD ["python", "-m", "uvicorn", "src.api:app", "--host", "0.0.0.0", "--port", "8001"]
