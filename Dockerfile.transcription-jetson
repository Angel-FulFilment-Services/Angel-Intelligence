# ==============================================================================
# Angel Intelligence - Transcription Pod Dockerfile (Jetson ARM64)
# ==============================================================================
# Shared WhisperX transcription service for NVIDIA Jetson / Thor
# Image size: ~4GB (torch + WhisperX + pyannote)
#
# Build: docker build -f Dockerfile.transcription-jetson -t angel-intelligence:transcription-arm64 .
# Run:   docker run --runtime nvidia -p 8001:8001 angel-intelligence:transcription-arm64

FROM dustynv/l4t-pytorch:r36.2.0

LABEL org.opencontainers.image.title="Angel Intelligence Transcription (Jetson)"
LABEL org.opencontainers.image.description="Shared WhisperX transcription service for ARM64"

# Fix ARM64 OpenMP TLS issue
ENV LD_PRELOAD=/usr/lib/aarch64-linux-gnu/libgomp.so.1
ENV PYTHONUNBUFFERED=1
ENV ANGEL_ENV=production

WORKDIR /workspace

# Install system dependencies (Python 3.10 already in base image)
RUN apt-get update && \
    apt-get install -y \
        sox libsox-fmt-all ffmpeg libopenblas-dev git curl \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip and reset index to PyPI (dustynv image has custom index)
RUN pip config set global.index-url https://pypi.org/simple && \
    pip config set global.extra-index-url https://pypi.org/simple && \
    pip install --upgrade pip setuptools wheel

# Copy requirements
COPY requirements/base.txt requirements/
COPY requirements/transcription.txt requirements/

# Install dependencies (torch already in base image)
RUN pip install --no-cache-dir --index-url https://pypi.org/simple -r requirements/transcription.txt

# Install WhisperX with compatible faster-whisper
RUN pip install faster-whisper==1.1.0 && \
    pip install git+https://github.com/m-bain/whisperx.git --no-deps && \
    pip install pyannote.audio

# Fix scikit-learn's bundled libgomp TLS conflict
RUN rm -f /usr/local/lib/python3.10/dist-packages/scikit_learn.libs/libgomp*.so* 2>/dev/null || true && \
    ln -sf /usr/lib/aarch64-linux-gnu/libgomp.so.1 /usr/local/lib/python3.10/dist-packages/scikit_learn.libs/libgomp-d22c30c5.so.1.0.0 2>/dev/null || true

# Copy only necessary code
COPY src/api/app.py src/api/
COPY src/api/routes.py src/api/
COPY src/api/__init__.py src/api/
COPY src/config/ src/config/
COPY src/database/ src/database/
COPY src/services/transcriber.py src/services/
COPY src/services/__init__.py src/services/
COPY src/__init__.py src/

EXPOSE 8001

CMD ["python", "-m", "uvicorn", "src.api:app", "--host", "0.0.0.0", "--port", "8001"]
