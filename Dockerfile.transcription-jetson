# ==============================================================================
# Angel Intelligence - Transcription Pod Dockerfile (Jetson ARM64)
# ==============================================================================
# Shared WhisperX transcription service for NVIDIA Jetson / Thor
# Image size: ~5GB (torch + WhisperX + pyannote + ctranslate2-cuda)
#
# Build: docker build -f Dockerfile.transcription-jetson -t angel-intelligence:transcription-arm64 .
# Run:   docker run --runtime nvidia -p 8001:8001 angel-intelligence:transcription-arm64

FROM dustynv/l4t-pytorch:r36.2.0

LABEL org.opencontainers.image.title="Angel Intelligence Transcription (Jetson)"
LABEL org.opencontainers.image.description="Shared WhisperX transcription service for ARM64"

# Fix ARM64 OpenMP TLS issue
ENV LD_PRELOAD=/usr/lib/aarch64-linux-gnu/libgomp.so.1
ENV PYTHONUNBUFFERED=1
ENV ANGEL_ENV=production

WORKDIR /workspace

# Install system dependencies including cmake for ctranslate2 build
RUN rm -rf /var/lib/apt/lists/* && \
    apt-get clean && \
    apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends \
        sox libsox-fmt-all ffmpeg libopenblas-dev git curl \
    && rm -rf /var/lib/apt/lists/*

# Use dusty-nv's Jetson pip server for CUDA-compiled wheels
# This has ctranslate2 and other packages pre-compiled for ARM64 CUDA
RUN pip config set global.index-url https://pypi.org/simple && \
    pip config set global.extra-index-url "https://pypi.jetson-ai-lab.io/jp6/cu126" && \
    pip install --upgrade pip setuptools wheel

# Copy requirements
COPY requirements/base.txt requirements/
COPY requirements/transcription.txt requirements/

# Install ctranslate2 with CUDA from Jetson pip server
RUN pip install --no-cache-dir ctranslate2

# Install dependencies (torch already in base image)
RUN pip install --no-cache-dir -r requirements/transcription.txt

# Install faster-whisper (will use CUDA ctranslate2 we just installed)
RUN pip install faster-whisper==1.1.0

# Install WhisperX and pyannote
RUN pip install git+https://github.com/m-bain/whisperx.git --no-deps && \
    pip install pyannote.audio

# Fix all bundled libgomp conflicts - find and replace ALL of them with system libgomp
RUN find /usr/local/lib -name "libgomp*.so*" -type f 2>/dev/null | while read f; do \
        rm -f "$f" && ln -sf /usr/lib/aarch64-linux-gnu/libgomp.so.1 "$f"; \
    done || true

# Copy only necessary code
COPY src/api/app.py src/api/
COPY src/api/auth.py src/api/
COPY src/api/routes.py src/api/
COPY src/api/routes_live.py src/api/
COPY src/api/__init__.py src/api/
COPY src/config/ src/config/
COPY src/database/ src/database/
COPY src/services/ src/services/
COPY src/__init__.py src/

EXPOSE 8001

CMD ["python", "-m", "uvicorn", "src.api:app", "--host", "0.0.0.0", "--port", "8001"]
